<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumen | Your Guide to the Inner World</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap');

        :root {
            --bg-color: #04071a; /* Deep Midnight Blue */
            --text-color: #E0E7FF; /* Lunar White */
            --text-color-secondary: #93a2c4;
            --accent-glow: #14b8a6; /* Shimmering Teal */
            --accent-warm: #facc15; /* Saffron Gold */
            --card-bg: rgba(12, 15, 29, 0.7);
            --border-color: rgba(20, 184, 166, 0.2);
            --glow-color: rgba(20, 184, 166, 0.15);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.7;
        }

        .container {
            width: 100%;
            max-width: 900px;
            padding: 40px 50px;
            position: relative;
            z-index: 1;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 0 70px rgba(0,0,0,0.6), inset 0 0 20px var(--glow-color);
        }

        .container::-webkit-scrollbar {
            width: 8px;
        }
        .container::-webkit-scrollbar-track {
            background: transparent;
        }
        .container::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 8px;
        }

        h1, h2, h3 {
            font-family: 'Inter', sans-serif;
            text-align: center;
            font-weight: 700;
        }

        h1 {
            font-size: 2.8rem;
            color: #ffffff;
            margin-bottom: 5px;
            letter-spacing: -1.5px;
            text-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        
        h1 .subtitle {
            font-size: 1rem;
            font-weight: 400;
            display: block;
            margin-top: 8px;
            letter-spacing: 1px;
            color: var(--text-color-secondary);
            text-transform: uppercase;
        }

        h2 {
            font-size: 1.8rem;
            color: #ffffff;
            margin-bottom: 30px;
            font-weight: 500;
        }
        
        h3 {
            font-size: 1.4rem;
            color: var(--accent-warm);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(250, 204, 21, 0.2);
            font-weight: 500;
            text-align: left;
        }

        p {
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--text-color);
        }
        
        textarea {
            width: 100%;
            min-height: 200px;
            padding: 20px;
            background-color: rgba(5, 6, 8, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-color);
            font-size: 1.1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-glow);
            box-shadow: 0 0 15px var(--glow-color);
        }
        
        .action-button {
            display: inline-block;
            margin-top: 20px;
            background: linear-gradient(45deg, var(--accent-glow), #2dd4bf);
            color: var(--bg-color);
            border: none;
            padding: 14px 35px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px var(--glow-color);
        }
        
        .action-button:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 5px 35px var(--glow-color);
        }

        .action-button:disabled {
            background: var(--text-color-secondary);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #analysis-section-container, #expansion-container {
            margin-top: 50px;
            padding-top: 40px;
            border-top: 1px solid var(--border-color);
            display: none;
        }
        
        .lens-nav {
            display: none; /* Hidden until analysis is complete */
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .lens-button {
            padding: 10px 20px;
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color-secondary);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .lens-button:hover {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .lens-button.active {
            background-color: var(--accent-glow);
            border-color: var(--accent-glow);
            color: var(--bg-color);
            font-weight: 700;
            box-shadow: 0 0 15px var(--glow-color);
        }
        
        .analysis-content {
            display: none;
            opacity: 0;
            transition: opacity 0.6s ease, transform 0.6s ease;
            transform: translateY(10px);
        }

        .analysis-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .analysis-content p,
        .analysis-content li {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Inter', sans-serif;
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .analysis-content ul {
            list-style: none;
            padding-left: 0;
        }

        .analysis-content li {
            padding-left: 25px;
            position: relative;
            margin-bottom: 12px;
        }

        .analysis-content li::before {
            content: '✧';
            position: absolute;
            left: 0;
            top: 0;
            color: var(--accent-glow);
            font-size: 1.2rem;
            line-height: 1.6;
        }

        #expansion-responses {
            margin-top: 20px;
        }

        .expansion-response-item {
            background-color: rgba(5, 6, 8, 0.5);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 16px;
            margin-top: 20px;
        }
        
        .expansion-response-item p {
             white-space: pre-wrap;
             word-wrap: break-word;
        }

        .error-message {
            text-align: center;
            color: #ff8a8a;
            font-style: italic;
            margin-top: 20px;
            display: none;
        }
        
        .disclaimer {
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.95rem;
            color: var(--text-color-secondary);
            opacity: 0.8;
        }

    </style>
</head>
<body>
    <canvas id="background-canvas"></canvas>
    <div class="container">
        <header>
            <h1>Lumen<span class="subtitle">An Oracle for the Inner World</span></h1>
            <p style="text-align: center; max-width: 600px; margin: 20px auto 40px;">Cross the threshold into your subconscious. Share the narrative of your dream, and Lumen will help illuminate the symbols, archetypes, and questions hidden within.</p>
        </header>
        
        <main>
            <section id="dream-input-section">
                <textarea id="dream-input" placeholder="Describe your dream here. Include as much detail as you can remember—the setting, the feelings, the colors, the characters..."></textarea>
                <div style="text-align: center;">
                    <button id="analyze-button" class="action-button">Illuminate Dream</button>
                </div>
                <p id="error-message" class="error-message"></p>
            </section>
            
            <section id="analysis-section-container">
                <h2>The Mirror's Reflection</h2>
                
                <div class="analysis-content active" id="summary-section">
                    <h3>Summary Analysis</h3>
                    <p id="summary-output"></p>
                </div>
                
                <div class="lens-nav" id="lens-navigation">
                    <button class="lens-button active" data-target="summary-section">Summary</button>
                    <button class="lens-button" data-target="symbols-section">Symbols</button>
                    <button class="lens-button" data-target="archetypes-section">Archetypes</button>
                    <button class="lens-button" data-target="questions-section">Questions</button>
                </div>
                
                <div class="analysis-content" id="symbols-section">
                    <h3>Symbolic Resonance</h3>
                    <p id="symbols-output"></p>
                </div>
                <div class="analysis-content" id="archetypes-section">
                    <h3>Archetypal Echoes</h3>
                    <p id="archetypes-output"></p>
                </div>
                <div class="analysis-content" id="questions-section">
                    <h3>Guiding Questions</h3>
                    <ul id="questions-list"></ul>
                </div>
            </section>

            <section id="expansion-container">
                <h3>Go Deeper</h3>
                <textarea id="expansion-input" placeholder="Ask about a specific symbol, feeling, or character to explore its meaning further..."></textarea>
                 <div style="text-align: center;">
                    <button id="expand-button" class="action-button">Expand on Detail</button>
                </div>
                <div id="expansion-responses"></div>
            </section>
        </main>
        
        <footer class="disclaimer">
            <p>Lumen is a tool for self-reflection and is not a substitute for professional therapeutic advice. Dream interpretation is a subjective art; these reflections are offered as catalysts for your own inner journey.</p>
        </footer>
    </div>

    <script>
        // --- Dynamic Background ---
        const canvas = document.getElementById('background-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationFrameId;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height * 1.2;
                this.z = Math.random() * 0.9 + 0.1;
                this.size = this.z * 2.5;
                this.speed = this.z * 0.3 + 0.1;
                this.opacity = this.z * 0.6;
            }
            update() {
                this.y -= this.speed;
                if (this.y < -this.size) this.reset();
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(34, 211, 238, ${this.opacity})`;
                ctx.fill();
            }
        }
        
        function init() {
            particles = [];
            const particleCount = Math.floor((canvas.width * canvas.height) / 8000);
            for (let i = 0; i < particleCount; i++) particles.push(new Particle());
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
            gradient.addColorStop(0, 'rgba(4, 7, 26, 0.3)');
            gradient.addColorStop(1, 'rgba(20, 184, 166, 0.1)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(p => { p.update(); p.draw(); });
            
            animationFrameId = requestAnimationFrame(animate);
        }

        window.addEventListener('resize', () => {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            resizeCanvas();
            init();
            animate();
        });

        // --- Application Logic ---
        const dreamInput = document.getElementById('dream-input');
        const analyzeButton = document.getElementById('analyze-button');
        const analysisSectionContainer = document.getElementById('analysis-section-container');
        const expansionContainer = document.getElementById('expansion-container');
        const expansionInput = document.getElementById('expansion-input');
        const expandButton = document.getElementById('expand-button');
        const expansionResponses = document.getElementById('expansion-responses');
        const errorMessage = document.getElementById('error-message');
        
        const summaryOutput = document.getElementById('summary-output');
        const symbolsOutput = document.getElementById('symbols-output');
        const archetypesOutput = document.getElementById('archetypes-output');
        const questionsList = document.getElementById('questions-list');
        const lensButtons = document.querySelectorAll('.lens-button');
        const analysisContents = document.querySelectorAll('.analysis-content');
        const lensNav = document.getElementById('lens-navigation');
        
        let initialDream = '';
        let analysisHistory = [];

        const callGeminiAPI = async (prompt) => {
            const apiKey = ""; // API key is auto-provided in the execution environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`API request failed with status: ${response.status}`);
            
            const result = await response.json();
            
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                return result.candidates[0].content.parts[0].text;
            } else {
                console.error("Unexpected API response format:", result);
                throw new Error("Received an unexpected response format from the API.");
            }
        };

        const analyzeDream = async () => {
            initialDream = dreamInput.value;
            if (initialDream.trim() === '') {
                showError('Please enter a dream to analyze.');
                return;
            }
            
            analysisHistory = [];
            expansionResponses.innerHTML = '';
            analyzeButton.disabled = true;
            analyzeButton.textContent = 'Illuminating...';
            errorMessage.style.display = 'none';

            const prompt = `
                Act as a wise, insightful dream analyst named Lumen. Your knowledge synthesizes the works of Carl Jung (archetypes, collective unconscious), Sigmund Freud (symbolism, displacement, condensation), Joseph Campbell (the hero's journey), James Hillman (sticking to the image), and Fritz Perls (Gestalt dialogue). Your purpose is to help the user understand the messages from their unconscious by providing a thoughtful, structured analysis.

                Analyze the following dream narrative:
                "${initialDream}"

                You MUST respond ONLY with a single, valid JSON object. The JSON object must have four keys: "summary", "symbolicResonance", "archetypalEchoes", and "guidingQuestions".
                - "summary": A comprehensive, one-paragraph 'Summary Analysis' capturing the core narrative, emotional tone, and central tension of the dream. This should provide immediate, insightful value.
                - "symbolicResonance": A detailed, multi-paragraph exploration of the key symbols, drawing connections between them and their potential psychological meanings, referencing both Freudian and Jungian concepts where applicable.
                - "archetypalEchoes": A detailed, multi-paragraph analysis of the major archetypal forces or narratives at play (e.g., The Hero's Journey, The Shadow, The Great Mother, The Wounded Healer), explaining how they might be manifesting in the dream's story.
                - "guidingQuestions": An array of exactly 3 thought-provoking, Socratic questions designed to help the user connect the dream's themes to their waking life, encouraging self-reflection in a Gestalt or Hillman-esque style (e.g., "If the monster in the dream could speak, what would it say to you?").
            `;
            
            try {
                const responseText = await callGeminiAPI(prompt);
                const jsonString = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
                const analysis = JSON.parse(jsonString);

                analysisHistory.push({role: 'user', text: `Analyze this dream: ${initialDream}`});
                analysisHistory.push({role: 'model', text: JSON.stringify(analysis, null, 2)});
                
                // Populate the analysis sections
                summaryOutput.innerHTML = analysis.summary.replace(/\n/g, '<br>');
                symbolsOutput.innerHTML = analysis.symbolicResonance.replace(/\n/g, '<br>');
                archetypesOutput.innerHTML = analysis.archetypalEchoes.replace(/\n/g, '<br>');
                
                questionsList.innerHTML = '';
                analysis.guidingQuestions.forEach(q => {
                    const li = document.createElement('li');
                    li.textContent = q;
                    questionsList.appendChild(li);
                });
                
                // Reset to default view (summary)
                lensButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector('.lens-button[data-target="summary-section"]').classList.add('active');
                analysisContents.forEach(section => section.classList.remove('active'));
                document.getElementById('summary-section').classList.add('active');


                analysisSectionContainer.style.display = 'block';
                lensNav.style.display = 'flex';
                expansionContainer.style.display = 'block';
                analysisSectionContainer.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                showError("Sorry, an error occurred while illuminating your dream. Please check the console for details.");
                console.error("Error in analyzeDream:", error);
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.textContent = 'Illuminate Dream';
            }
        };

        lensButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.target;
                
                lensButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                analysisContents.forEach(section => {
                    if (section.id === targetId) {
                        section.classList.add('active');
                    } else {
                        section.classList.remove('active');
                    }
                });
            });
        });
        
        const expandOnDetail = async () => {
            const detailQuery = expansionInput.value;
            if(detailQuery.trim() === '') {
                 showError('Please enter a detail you wish to explore.', true);
                 return;
            }

            expandButton.disabled = true;
            expandButton.textContent = 'Expanding...';
            errorMessage.style.display = 'none';

            const prompt = `
                You are Lumen, a dream analyst, continuing a conversation.
                The original dream was: "${initialDream}"
                The previous analysis provided was: ${analysisHistory.find(turn => turn.role === 'model')?.text || '{}'}

                The user now wants to go deeper on a specific point. Their query is: "${detailQuery}"

                Provide a focused, 1-2 paragraph response that elaborates on this specific detail, drawing connections back to the original dream and your wider knowledge of psychology and mythology.
            `;
            
            try {
                const expansionText = await callGeminiAPI(prompt);
                
                analysisHistory.push({role: 'user', text: detailQuery});
                analysisHistory.push({role: 'model', text: expansionText});

                const newResponseItem = document.createElement('div');
                newResponseItem.className = 'expansion-response-item';
                newResponseItem.innerHTML = `<p><strong>You asked about:</strong> "${detailQuery}"</p><p>${expansionText.replace(/\n/g, '<br>')}</p>`;
                expansionResponses.appendChild(newResponseItem);
                expansionInput.value = '';
                newResponseItem.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showError("Sorry, an error occurred during the expansion. Please try again.", true);
                console.error("Error in expandOnDetail:", error);
            } finally {
                expandButton.disabled = false;
                expandButton.textContent = 'Expand on Detail';
            }
        };
        
        function showError(message, isExpansion = false) {
             if(isExpansion) {
                alert(message);
             } else {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                setTimeout(() => { errorMessage.style.display = 'none'; }, 4000);
             }
        }

        analyzeButton.addEventListener('click', analyzeDream);
        expandButton.addEventListener('click', expandOnDetail);

        // Initial setup
        resizeCanvas();
        init();
        animate();
    </script>
</body>
</html>
